create database littleMarket;

use littleMarket;

create table tbprodutos(
    id INT AUTO_INCREMENT PRIMARY KEY,
    nome VARCHAR(100) NOT NULL,
    descricao TEXT,
    preco DECIMAL(10,2) NOT NULL,
    estoque INT,
    imagem_url VARCHAR(255)
); 

CREATE TABLE tbpedidos (
    id INT PRIMARY KEY auto_increment,
    produto_id INT NOT NULL,
    user_id int not null,
    quantidade INT NOT NULL,
    data_pedido TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    status ENUM('pendente', 'processando', 'concluido', 'cancelado') DEFAULT 'pendente',
    FOREIGN KEY (produto_id) REFERENCES tbprodutos(id),
    FOREIGN KEY (user_id) REFERENCES tbuser(id)
);

create table tbuser(
    id INT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL,
    user_type TINYINT NOT NULL DEFAULT 1 COMMENT '1=Normal, 2=Funcionario',
    email VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Para pedidos criados atualizar o estoque
DELIMITER //

CREATE TRIGGER after_pedido_insert
AFTER INSERT ON tbpedidos
FOR EACH ROW
BEGIN
    -- Atualiza o estoque do produto
    UPDATE produtos
    SET estoque = estoque - NEW.quantidade
    WHERE id = NEW.produto_id;
    
    -- Verifica se o estoque ficou negativo
    IF (SELECT estoque FROM produtos WHERE id = NEW.produto_id) < 0 THEN
        -- Reverte a operação
        UPDATE tbprodutos
        SET estoque = estoque + NEW.quantidade
        WHERE id = NEW.produto_id;
        
        -- Cancela o pedido
        UPDATE tbpedidos
        SET status = 'cancelado'
        WHERE id = NEW.id;
        
        -- Gera um erro
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Estoque insuficiente para o produto';
    END IF;
END//

DELIMITER ;

-- Para cancelamento de pedidos
DELIMITER //

CREATE TRIGGER after_pedido_cancel
AFTER UPDATE ON tbpedidos
FOR EACH ROW
BEGIN
    -- Se o status mudou para cancelado, devolve o estoque
    IF OLD.status != 'cancelado' AND NEW.status = 'cancelado' THEN
        UPDATE tbprodutos
        SET estoque = estoque + OLD.quantidade
        WHERE id = OLD.produto_id;
    END IF;
END//

DELIMITER ;

